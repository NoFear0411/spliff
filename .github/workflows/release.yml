# spliff Release Workflow
#
# Creates releases with binary packages when a version tag is pushed.
# Builds for: Fedora 43, AlmaLinux 10/9, Ubuntu 24.04, Debian Bookworm, Arch
# Publishes .deb/.rpm packages to GitHub Releases

name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # ==========================================================================
  # Fedora 43 (Full feature support - primary build target)
  # ==========================================================================
  build-fedora-43:
    name: Build (Fedora 43)
    runs-on: ubuntu-latest
    container: fedora:43

    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            git cmake make pkg-config \
            gcc gcc-c++ clang llvm \
            libbpf-devel elfutils-libelf-devel zlib-devel \
            llhttp-devel libnghttp2-devel \
            ck-devel \
            libzstd-devel brotli-devel \
            libxdp-devel userspace-rcu-devel \
            jemalloc-devel pcre2-devel \
            rpm-build

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Release)
        run: cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF

      - name: Build
        run: cmake --build build-release --parallel

      - name: Create RPM package
        run: cd build-release && cpack -G RPM

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spliff-fedora-43
          path: |
            build-release/spliff
            build-release/*.rpm
          retention-days: 7

  # ==========================================================================
  # Fedora 42 (Full feature support)
  # ==========================================================================
  build-fedora-42:
    name: Build (Fedora 42)
    runs-on: ubuntu-latest
    container: fedora:42

    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            git cmake make pkg-config \
            gcc gcc-c++ clang llvm \
            libbpf-devel elfutils-libelf-devel zlib-devel \
            llhttp-devel libnghttp2-devel \
            ck-devel \
            libzstd-devel brotli-devel \
            libxdp-devel userspace-rcu-devel \
            jemalloc-devel pcre2-devel \
            rpm-build

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Release)
        run: cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF

      - name: Build
        run: cmake --build build-release --parallel

      - name: Create RPM package
        run: cd build-release && cpack -G RPM

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spliff-fedora-42
          path: |
            build-release/spliff
            build-release/*.rpm
          retention-days: 7

  # ==========================================================================
  # AlmaLinux 10 (RHEL 10 Compatible)
  # ==========================================================================
  build-alma10:
    name: Build (AlmaLinux 10)
    runs-on: ubuntu-latest
    container: almalinux:10

    steps:
      - name: Enable EPEL and CRB
        run: |
          dnf install -y epel-release
          dnf config-manager --set-enabled crb || true

      - name: Install dependencies
        run: |
          dnf install -y --allowerasing \
            git cmake make pkg-config curl \
            gcc gcc-c++ clang llvm \
            elfutils-libelf-devel zlib-devel \
            llhttp-devel libnghttp2-devel \
            libzstd-devel brotli-devel \
            userspace-rcu-devel pcre2-devel \
            jemalloc-devel \
            rpm-build

      - name: Build libbpf from source
        run: |
          cd /tmp
          curl -sL https://github.com/libbpf/libbpf/archive/refs/tags/v1.4.0.tar.gz | tar xz
          cd libbpf-1.4.0/src
          make -j$(nproc)
          make install
          ldconfig

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Release)
        run: |
          export PKG_CONFIG_PATH=/usr/lib64/pkgconfig:/usr/local/lib64/pkgconfig
          cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF -DENABLE_XDP=OFF

      - name: Build
        run: cmake --build build-release --parallel

      - name: Create RPM package
        run: cd build-release && cpack -G RPM

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spliff-almalinux-10
          path: |
            build-release/spliff
            build-release/*.rpm
          retention-days: 7

  # ==========================================================================
  # AlmaLinux 9 (RHEL 9 Compatible)
  # ==========================================================================
  build-alma9:
    name: Build (AlmaLinux 9)
    runs-on: ubuntu-latest
    container: almalinux:9

    steps:
      - name: Enable EPEL and CRB
        run: |
          dnf install -y epel-release
          dnf config-manager --set-enabled crb || true

      - name: Install dependencies
        run: |
          dnf install -y --allowerasing \
            git cmake make pkg-config curl \
            gcc gcc-c++ clang llvm \
            elfutils-libelf-devel zlib-devel \
            llhttp-devel libnghttp2-devel \
            libzstd-devel brotli-devel \
            userspace-rcu-devel pcre2-devel \
            jemalloc-devel \
            rpm-build

      - name: Build libbpf from source
        run: |
          cd /tmp
          curl -sL https://github.com/libbpf/libbpf/archive/refs/tags/v1.4.0.tar.gz | tar xz
          cd libbpf-1.4.0/src
          make -j$(nproc)
          make install
          ldconfig

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Release)
        run: |
          export PKG_CONFIG_PATH=/usr/lib64/pkgconfig:/usr/local/lib64/pkgconfig
          cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF -DENABLE_XDP=OFF

      - name: Build
        run: cmake --build build-release --parallel

      - name: Create RPM package
        run: cd build-release && cpack -G RPM

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spliff-almalinux-9
          path: |
            build-release/spliff
            build-release/*.rpm
          retention-days: 7

  # ==========================================================================
  # Ubuntu 24.04 LTS (Noble)
  # ==========================================================================
  build-ubuntu:
    name: Build (Ubuntu 24.04)
    runs-on: ubuntu-latest
    container: ubuntu:24.04

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git cmake make pkg-config curl ca-certificates \
            gcc g++ clang llvm \
            libbpf-dev libelf-dev zlib1g-dev \
            libnghttp2-dev \
            libzstd-dev libbrotli-dev \
            libxdp-dev liburcu-dev \
            libjemalloc-dev libpcre2-dev \
            dpkg-dev file
        env:
          DEBIAN_FRONTEND: noninteractive

      - name: Build llhttp from source
        run: |
          cd /tmp
          curl -sL https://github.com/nodejs/llhttp/archive/refs/tags/release/v9.2.1.tar.gz | tar xz
          cd llhttp-release-v9.2.1
          cmake -B build -DBUILD_SHARED_LIBS=ON
          cmake --build build
          cmake --install build
          ldconfig

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Release)
        run: cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF

      - name: Build
        run: cmake --build build-release --parallel

      - name: Create DEB package
        run: cd build-release && cpack -G DEB

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spliff-ubuntu-24.04
          path: |
            build-release/spliff
            build-release/*.deb
          retention-days: 7

  # ==========================================================================
  # Debian 13 (Trixie) - Full feature support with native packages
  # ==========================================================================
  build-debian-13:
    name: Build (Debian 13)
    runs-on: ubuntu-latest
    container: debian:trixie

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git cmake make pkg-config curl ca-certificates \
            gcc g++ clang llvm \
            libbpf-dev libelf-dev zlib1g-dev \
            libllhttp-dev libnghttp2-dev \
            libck-dev \
            libzstd-dev libbrotli-dev \
            libxdp-dev liburcu-dev \
            libjemalloc-dev libpcre2-dev \
            dpkg-dev file
        env:
          DEBIAN_FRONTEND: noninteractive

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Release)
        run: cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF

      - name: Build
        run: cmake --build build-release --parallel

      - name: Create DEB package
        run: cd build-release && cpack -G DEB

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spliff-debian-13
          path: |
            build-release/spliff
            build-release/*.deb
          retention-days: 7

  # ==========================================================================
  # Debian 12 (Bookworm) - llhttp built from source
  # ==========================================================================
  build-debian-12:
    name: Build (Debian 12)
    runs-on: ubuntu-latest
    container: debian:bookworm

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git cmake make pkg-config curl ca-certificates \
            gcc g++ clang llvm \
            libbpf-dev libelf-dev zlib1g-dev \
            libnghttp2-dev \
            libzstd-dev libbrotli-dev \
            libxdp-dev liburcu-dev \
            libjemalloc-dev libpcre2-dev \
            dpkg-dev file
        env:
          DEBIAN_FRONTEND: noninteractive

      - name: Build llhttp from source
        run: |
          cd /tmp
          curl -sL https://github.com/nodejs/llhttp/archive/refs/tags/release/v9.2.1.tar.gz | tar xz
          cd llhttp-release-v9.2.1
          cmake -B build -DBUILD_SHARED_LIBS=ON
          cmake --build build
          cmake --install build
          ldconfig

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Release)
        run: cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF

      - name: Build
        run: cmake --build build-release --parallel

      - name: Create DEB package
        run: cd build-release && cpack -G DEB

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spliff-debian-12
          path: |
            build-release/spliff
            build-release/*.deb
          retention-days: 7

  # ==========================================================================
  # Arch Linux (Rolling Release) - Binary only, no package
  # ==========================================================================
  build-arch:
    name: Build (Arch Linux)
    runs-on: ubuntu-latest
    container: archlinux:latest

    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm \
            git cmake make pkg-config curl \
            gcc clang llvm \
            libbpf libelf zlib \
            libnghttp2 \
            zstd brotli \
            xdp-tools liburcu \
            jemalloc pcre2

      - name: Build llhttp from source
        run: |
          cd /tmp
          curl -sL https://github.com/nodejs/llhttp/archive/refs/tags/release/v9.2.1.tar.gz | tar xz
          cd llhttp-release-v9.2.1
          cmake -B build -DBUILD_SHARED_LIBS=ON
          cmake --build build
          cmake --install build
          ldconfig

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Release)
        run: cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF

      - name: Build
        run: cmake --build build-release --parallel

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spliff-arch
          path: build-release/spliff
          retention-days: 7

  # ==========================================================================
  # Create GitHub Release with Packages
  # ==========================================================================
  release:
    name: Create Release
    needs: [build-fedora-43, build-fedora-42, build-alma10, build-alma9, build-ubuntu, build-debian-13, build-debian-12, build-arch]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Try to extract the section for this version from CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            CHANGELOG=$(awk -v ver="$VERSION" '
              /^## \[?v?'"$VERSION"'\]?/ { found=1; next }
              /^## \[?v?[0-9]/ && found { exit }
              found { print }
            ' CHANGELOG.md)

            if [ -z "$CHANGELOG" ]; then
              CHANGELOG=$(awk -v ver="$VERSION" '
                /^## \[?'"$VERSION"'\]?/ { found=1; next }
                /^## \[?[0-9]/ && found { exit }
                found { print }
              ' CHANGELOG.md)
            fi
          fi

          # If no changelog found, use git log
          if [ -z "$CHANGELOG" ]; then
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$PREV_TAG" ]; then
              CHANGELOG=$(git log --pretty=format:"- %s" "$PREV_TAG"..HEAD)
            else
              CHANGELOG="Initial release"
            fi
          fi

          echo "$CHANGELOG" > /tmp/changelog.txt
          echo "file=/tmp/changelog.txt" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        id: assets
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p release

          # Copy binaries with distro suffix
          for dir in artifacts/spliff-*; do
            distro=$(basename "$dir" | sed 's/spliff-//')
            if [ -f "$dir/spliff" ]; then
              cp "$dir/spliff" "release/spliff-${VERSION}-${distro}"
              chmod +x "release/spliff-${VERSION}-${distro}"
            fi
          done

          # Copy all packages (already have version in filename from CPack)
          find artifacts -name '*.deb' -exec cp {} release/ \;
          find artifacts -name '*.rpm' -exec cp {} release/ \;

          # Generate checksums
          cd release
          sha256sum * > SHA256SUMS.txt

          echo "Release assets:"
          ls -la

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: spliff ${{ steps.version.outputs.tag }}
          body_path: ${{ steps.changelog.outputs.file }}
          files: release/*
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
