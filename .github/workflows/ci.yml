# spliff CI - Build and Test
#
# Multi-distro Linux build and test workflow for CMake-based eBPF project.

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ==========================================================================
  # Ubuntu LTS
  # ==========================================================================
  ubuntu:
    name: Ubuntu ${{ matrix.version }} (${{ matrix.compiler }}, ${{ matrix.build_type }})
    runs-on: ubuntu-latest
    container: ubuntu:${{ matrix.version }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - version: "24.04"
            compiler: gcc
            build_type: Debug
            sanitizers: ON
          - version: "24.04"
            compiler: clang
            build_type: Debug
            sanitizers: ON
          - version: "24.04"
            compiler: gcc
            build_type: Release
            sanitizers: OFF
          - version: "22.04"
            compiler: gcc
            build_type: Debug
            sanitizers: ON

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git cmake make pkg-config \
            gcc g++ clang llvm \
            libbpf-dev libelf-dev zlib1g-dev \
            libllhttp-dev libnghttp2-dev \
            libzstd-dev libbrotli-dev \
            libck-dev libxdp-dev liburcu-dev \
            libjemalloc-dev libpcre2-dev
        env:
          DEBIAN_FRONTEND: noninteractive

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_C_COMPILER=${{ matrix.compiler }} \
            -DENABLE_SANITIZERS=${{ matrix.sanitizers }}

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: |
          cmake --build build --target test_http1 test_http2 test_xdp
          cd build && ctest --output-on-failure

      - name: Upload artifacts
        if: matrix.build_type == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: spliff-ubuntu-${{ matrix.version }}
          path: build/spliff
          retention-days: 7

  # ==========================================================================
  # Debian Stable
  # ==========================================================================
  debian:
    name: Debian ${{ matrix.codename }}
    runs-on: ubuntu-latest
    container: debian:${{ matrix.codename }}

    strategy:
      fail-fast: false
      matrix:
        codename: [bookworm, bullseye]

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git cmake make pkg-config curl \
            gcc g++ clang llvm \
            libbpf-dev libelf-dev zlib1g-dev \
            libnghttp2-dev libzstd-dev libbrotli-dev \
            liburcu-dev libpcre2-dev
        env:
          DEBIAN_FRONTEND: noninteractive

      - name: Build llhttp from source
        run: |
          cd /tmp
          curl -sL https://github.com/nodejs/llhttp/archive/refs/tags/release/v9.2.1.tar.gz | tar xz
          cd llhttp-release-v9.2.1
          cmake -B build -DBUILD_SHARED_LIBS=ON
          cmake --build build
          cmake --install build
          ldconfig

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_XDP=OFF

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: |
          cmake --build build --target test_http1 test_http2 || true
          cd build && ctest --output-on-failure || true
        continue-on-error: true

  # ==========================================================================
  # Fedora
  # ==========================================================================
  fedora:
    name: Fedora ${{ matrix.version }}
    runs-on: ubuntu-latest
    container: fedora:${{ matrix.version }}

    strategy:
      fail-fast: false
      matrix:
        version: [43, 42]

    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            git cmake make pkg-config \
            gcc gcc-c++ clang llvm \
            libbpf-devel elfutils-libelf-devel zlib-devel \
            llhttp-devel libnghttp2-devel \
            libzstd-devel brotli-devel \
            ck-devel libxdp-devel userspace-rcu-devel \
            jemalloc-devel pcre2-devel

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_SANITIZERS=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: |
          cmake --build build --target test_http1 test_http2 test_xdp
          cd build && ctest --output-on-failure

  # ==========================================================================
  # Arch Linux
  # ==========================================================================
  arch:
    name: Arch Linux
    runs-on: ubuntu-latest
    container: archlinux:latest

    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm \
            git cmake make pkg-config curl \
            gcc clang llvm \
            libbpf libelf zlib \
            nghttp2 zstd brotli \
            liburcu pcre2

      - name: Build llhttp from source
        run: |
          cd /tmp
          curl -sL https://github.com/nodejs/llhttp/archive/refs/tags/release/v9.2.1.tar.gz | tar xz
          cd llhttp-release-v9.2.1
          cmake -B build -DBUILD_SHARED_LIBS=ON
          cmake --build build
          cmake --install build
          ldconfig

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_XDP=OFF

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: |
          cmake --build build --target test_http1 test_http2 || true
          cd build && ctest --output-on-failure || true
        continue-on-error: true

  # ==========================================================================
  # AlmaLinux / Rocky (RHEL 9 Compatible)
  # ==========================================================================
  rhel-compatible:
    name: ${{ matrix.distro }} ${{ matrix.version }}
    runs-on: ubuntu-latest
    container: ${{ matrix.container }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: AlmaLinux
            version: "9"
            container: almalinux:9
          - distro: Rocky
            version: "9"
            container: rockylinux:9

    steps:
      - name: Enable EPEL
        run: |
          dnf install -y epel-release
          dnf config-manager --set-enabled crb || true

      - name: Install dependencies
        run: |
          dnf install -y \
            git cmake make pkg-config curl \
            gcc gcc-c++ clang llvm \
            elfutils-libelf-devel zlib-devel \
            libnghttp2-devel libzstd-devel brotli-devel \
            userspace-rcu-devel pcre2-devel

      - name: Build libbpf from source
        run: |
          cd /tmp
          curl -sL https://github.com/libbpf/libbpf/archive/refs/tags/v1.4.0.tar.gz | tar xz
          cd libbpf-1.4.0/src
          make -j$(nproc)
          make install
          ldconfig

      - name: Build llhttp from source
        run: |
          cd /tmp
          curl -sL https://github.com/nodejs/llhttp/archive/refs/tags/release/v9.2.1.tar.gz | tar xz
          cd llhttp-release-v9.2.1
          cmake -B build -DBUILD_SHARED_LIBS=ON
          cmake --build build
          cmake --install build
          ldconfig

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        run: |
          export PKG_CONFIG_PATH=/usr/lib64/pkgconfig:/usr/local/lib64/pkgconfig
          cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_XDP=OFF

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: |
          cmake --build build --target test_http1 test_http2 || true
          cd build && ctest --output-on-failure || true
        continue-on-error: true

  # ==========================================================================
  # Code Coverage
  # ==========================================================================
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    container: ubuntu:24.04

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git cmake make pkg-config gcc g++ lcov \
            libbpf-dev libelf-dev zlib1g-dev \
            libllhttp-dev libnghttp2-dev \
            libzstd-dev libbrotli-dev \
            libck-dev libxdp-dev liburcu-dev \
            libjemalloc-dev libpcre2-dev clang llvm
        env:
          DEBIAN_FRONTEND: noninteractive

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build with Coverage
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DENABLE_COVERAGE=ON \
            -DENABLE_SANITIZERS=OFF
          cmake --build build --parallel

      - name: Run Tests
        run: |
          cmake --build build --target test_http1 test_http2 test_xdp
          cd build && ctest --output-on-failure

      - name: Generate Report
        run: |
          lcov --capture --directory build --output-file build/coverage.info \
            --ignore-errors mismatch
          lcov --remove build/coverage.info '/usr/*' '*/tests/*' \
            --output-file build/coverage.info --ignore-errors unused

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: build/coverage.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ==========================================================================
  # Static Analysis
  # ==========================================================================
  analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    container: ubuntu:24.04

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git cmake make pkg-config gcc g++ cppcheck \
            libbpf-dev libelf-dev zlib1g-dev \
            libllhttp-dev libnghttp2-dev \
            libzstd-dev libbrotli-dev \
            libck-dev libxdp-dev liburcu-dev \
            libjemalloc-dev libpcre2-dev clang llvm
        env:
          DEBIAN_FRONTEND: noninteractive

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        run: cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: cppcheck
        run: |
          cppcheck --enable=warning,performance,portability \
            --error-exitcode=0 --inline-suppr \
            --suppress=missingIncludeSystem \
            -I src/include src/
