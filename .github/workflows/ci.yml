# spliff CI - Multi-Distribution Build Check
#
# Verifies release builds with full features on supported distributions.
# All dependencies installed from distribution repos (main/EPEL).

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  fedora-43:
    name: Fedora 43
    runs-on: ubuntu-latest
    container: fedora:43
    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            git cmake make pkg-config gcc gcc-c++ clang llvm \
            libbpf-devel elfutils-libelf-devel zlib-devel \
            llhttp-devel libnghttp2-devel ck-devel \
            libzstd-devel brotli-devel libxdp-devel \
            userspace-rcu-devel jemalloc-devel pcre2-devel

      - uses: actions/checkout@v4

      - name: Build Release
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF
          cmake --build build --parallel

      - name: Run Tests
        run: |
          cmake --build build --target build_tests
          cd build && ctest --output-on-failure

  fedora-42:
    name: Fedora 42
    runs-on: ubuntu-latest
    container: fedora:42
    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            git cmake make pkg-config gcc gcc-c++ clang llvm \
            libbpf-devel elfutils-libelf-devel zlib-devel \
            llhttp-devel libnghttp2-devel ck-devel \
            libzstd-devel brotli-devel libxdp-devel \
            userspace-rcu-devel jemalloc-devel pcre2-devel

      - uses: actions/checkout@v4

      - name: Build Release
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF
          cmake --build build --parallel

      - name: Run Tests
        run: |
          cmake --build build --target build_tests
          cd build && ctest --output-on-failure

  debian-13:
    name: Debian 13
    runs-on: ubuntu-latest
    container: debian:trixie
    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git cmake make pkg-config gcc g++ clang llvm \
            libbpf-dev libelf-dev zlib1g-dev \
            libllhttp-dev libnghttp2-dev libck-dev \
            libzstd-dev libbrotli-dev libxdp-dev \
            liburcu-dev libjemalloc-dev libpcre2-dev
        env:
          DEBIAN_FRONTEND: noninteractive

      - uses: actions/checkout@v4

      - name: Build Release
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF
          cmake --build build --parallel

      - name: Run Tests
        run: |
          cmake --build build --target build_tests
          cd build && ctest --output-on-failure

  debian-12:
    name: Debian 12
    runs-on: ubuntu-latest
    container: debian:bookworm
    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git cmake make pkg-config gcc g++ clang llvm \
            libbpf-dev libelf-dev zlib1g-dev \
            libllhttp-dev libnghttp2-dev libck-dev \
            libzstd-dev libbrotli-dev libxdp-dev \
            liburcu-dev libjemalloc-dev libpcre2-dev
        env:
          DEBIAN_FRONTEND: noninteractive

      - uses: actions/checkout@v4

      - name: Build Release
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF
          cmake --build build --parallel

      - name: Run Tests
        run: |
          cmake --build build --target build_tests
          cd build && ctest --output-on-failure

  ubuntu-24:
    name: Ubuntu 24.04
    runs-on: ubuntu-latest
    container: ubuntu:24.04
    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git cmake make pkg-config gcc g++ clang llvm \
            libbpf-dev libelf-dev zlib1g-dev \
            libllhttp-dev libnghttp2-dev libck-dev \
            libzstd-dev libbrotli-dev libxdp-dev \
            liburcu-dev libjemalloc-dev libpcre2-dev
        env:
          DEBIAN_FRONTEND: noninteractive

      - uses: actions/checkout@v4

      - name: Build Release
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF
          cmake --build build --parallel

      - name: Run Tests
        run: |
          cmake --build build --target build_tests
          cd build && ctest --output-on-failure

  alma-10:
    name: AlmaLinux 10
    runs-on: ubuntu-latest
    container: almalinux:10
    steps:
      - name: Enable EPEL and CRB
        run: |
          dnf install -y epel-release
          dnf config-manager --set-enabled crb || true

      - name: Install dependencies
        run: |
          dnf install -y --allowerasing \
            git cmake make pkg-config gcc gcc-c++ clang llvm \
            libbpf-devel elfutils-libelf-devel zlib-devel \
            llhttp-devel libnghttp2-devel ck-devel \
            libzstd-devel brotli-devel libxdp-devel \
            userspace-rcu-devel jemalloc-devel pcre2-devel

      - uses: actions/checkout@v4

      - name: Build Release
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF
          cmake --build build --parallel

      - name: Run Tests
        run: |
          cmake --build build --target build_tests
          cd build && ctest --output-on-failure

  alma-9:
    name: AlmaLinux 9
    runs-on: ubuntu-latest
    container: almalinux:9
    steps:
      - name: Enable EPEL and CRB
        run: |
          dnf install -y epel-release
          dnf config-manager --set-enabled crb || true

      - name: Install dependencies
        run: |
          dnf install -y --allowerasing \
            git cmake make pkg-config gcc gcc-c++ clang llvm \
            libbpf-devel elfutils-libelf-devel zlib-devel \
            llhttp-devel libnghttp2-devel ck-devel \
            libzstd-devel brotli-devel libxdp-devel \
            userspace-rcu-devel jemalloc-devel pcre2-devel

      - uses: actions/checkout@v4

      - name: Build Release
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF
          cmake --build build --parallel

      - name: Run Tests
        run: |
          cmake --build build --target build_tests
          cd build && ctest --output-on-failure

  arch:
    name: Arch Linux
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm \
            git cmake make pkgconf gcc clang llvm \
            libbpf libelf zlib \
            llhttp libnghttp2 ck \
            zstd brotli libxdp \
            liburcu jemalloc pcre2

      - uses: actions/checkout@v4

      - name: Build Release
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_SANITIZERS=OFF
          cmake --build build --parallel

      - name: Run Tests
        run: |
          cmake --build build --target build_tests
          cd build && ctest --output-on-failure
